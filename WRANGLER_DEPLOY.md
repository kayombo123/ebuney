# Deploying to Cloudflare Pages using Wrangler CLI

This guide covers deploying your Next.js app to Cloudflare Pages using Wrangler CLI.

## Important: Build Output Required

**You cannot deploy source files directly.** Next.js apps require the build output generated by `@cloudflare/next-on-pages` adapter, which creates the necessary files in `.vercel/output/static` directory.

## Option 1: Automated Deployment via GitHub Actions (Recommended)

The easiest way is to use GitHub Actions to build and deploy automatically.

### Setup:

1. **Get Cloudflare API Token:**
   - Go to https://dash.cloudflare.com/profile/api-tokens
   - Click "Create Token"
   - Use "Edit Cloudflare Workers" template
   - Add permissions: Account → Cloudflare Pages → Edit
   - Copy the token

2. **Get Cloudflare Account ID:**
   - Go to https://dash.cloudflare.com/
   - Select your account
   - Copy the Account ID from the right sidebar

3. **Add GitHub Secrets:**
   - Go to your GitHub repository → Settings → Secrets and variables → Actions
   - Add these secrets:
     - `CLOUDFLARE_API_TOKEN` - Your API token from step 1
     - `CLOUDFLARE_ACCOUNT_ID` - Your Account ID from step 2
     - `NEXT_PUBLIC_SUPABASE_URL` - Your Supabase URL
     - `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Your Supabase anon key

4. **Push to GitHub:**
   - The workflow (`.github/workflows/deploy-cloudflare.yml`) will automatically build and deploy on every push to `main` branch
   - You can also manually trigger it from the Actions tab

## Option 2: Manual Deployment (Using WSL or Linux)

If you want to deploy manually from Windows, you need to build the project first. Since the build requires bash, you'll need WSL (Windows Subsystem for Linux).

### Prerequisites:
- WSL installed (or access to a Linux machine)
- Cloudflare account
- Wrangler CLI installed globally: `npm install -g wrangler`

### Steps:

1. **Install WSL (if not already installed):**
   ```powershell
   wsl --install
   ```
   Then restart your computer and set up Ubuntu.

2. **Open WSL and navigate to your project:**
   ```bash
   cd /mnt/c/Users/USER/ebuney
   ```

3. **Install dependencies:**
   ```bash
   npm ci
   ```

4. **Build the project:**
   ```bash
   npm run build:cloudflare
   ```
   
   Make sure environment variables are set:
   ```bash
   export NEXT_PUBLIC_SUPABASE_URL="https://grxyvzpapamomhfipjfk.supabase.co"
   export NEXT_PUBLIC_SUPABASE_ANON_KEY="your_anon_key_here"
   ```

5. **Login to Cloudflare (if not already):**
   ```bash
   npx wrangler login
   ```

6. **Deploy to Cloudflare Pages:**
   
   Option A: Use the npm script (recommended):
   ```bash
   npm run deploy:cloudflare
   ```
   
   Option B: Deploy manually:
   ```bash
   npx wrangler pages deploy .vercel/output/static --project-name=ebuneyzm
   ```

7. **Set environment variables (if not already set):**
   ```bash
   npx wrangler pages secret put NEXT_PUBLIC_SUPABASE_URL --project-name=ebuneyzm
   npx wrangler pages secret put NEXT_PUBLIC_SUPABASE_ANON_KEY --project-name=ebuneyzm
   ```

## Option 3: Deploy via Cloudflare Dashboard (Git-based)

This is the simplest option and doesn't require local builds:

1. Go to https://dash.cloudflare.com/
2. Navigate to Workers & Pages → Create application → Pages
3. Connect your GitHub repository
4. Configure build settings:
   - Build command: `npm run build:cloudflare`
   - Build output directory: `.vercel/output/static`
5. Add environment variables
6. Deploy

## Configuration Files

Your project is already configured with:

### `wrangler.toml`
- Project name: `ebuney`
- Build output directory: `.vercel/output/static`
- Environment variables are set in `[vars]` section

### `package.json`
- Build script: `build:cloudflare` runs Next.js build + Cloudflare adapter
- Wrangler is installed as a dev dependency

## Verification

After deployment:
1. Your site will be available at: `https://ebuneyzm.pages.dev` (or your custom domain)
2. Check the deployment logs in Cloudflare dashboard
3. Verify environment variables are set correctly
4. Test all routes to ensure routing works correctly

## Troubleshooting

### Build Fails
- Ensure you're using Node.js 18+ or 20
- Check that all dependencies are installed
- Verify environment variables are set

### Deployment Fails
- Check that `.vercel/output/static` directory exists
- Verify Cloudflare API token has correct permissions
- Ensure project name matches in Cloudflare dashboard

### 404 Errors After Deployment
- This usually means the build output wasn't deployed correctly
- Verify you're deploying `.vercel/output/static`, not source files
- Check that the Cloudflare adapter ran successfully during build

## Files Structure for Deployment

```
.vercel/output/static/  ← Deploy THIS directory
├── _worker.js          ← Cloudflare adapter worker
├── _routes.json        ← Routing configuration
├── _next/              ← Next.js assets
├── index.html          ← Entry point
└── [other static files]
```

**DO NOT deploy:**
- `app/` (source code)
- `components/` (source code)
- `node_modules/`
- `.next/` (intermediate build files)

Only deploy `.vercel/output/static/` which is generated by the build process.

